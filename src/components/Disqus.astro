<!--
  Src:
    Artur Sopelnik
    https://webdesign-sopelnik.de/en/blog/adding-comments-to-your-astro-blog-with-disqus/

  Usage:
    import Disqus from "@components/Disqus.astro";
    <Disqus slug={slug} title={title} />
-->
<div id="disqus_thread" class="disqus-thread"></div>

<script is:inline>
  if (!window.DisqusWidget) {
    window.DisqusWidget = {
      overwriteGlobalSelectors: function () {
        window.$disqus = document.querySelector("#disqus_thread");
      },
      init: function () {
        this.overwriteGlobalSelectors();
        this.addListeners();
        this.waitForPageReady();
      },
      addListeners: function () {
        // 使用 IntersectionObserver 来延迟加载 Disqus
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              this.loadDisqus();
              observer.disconnect(); // 加载完成后断开观察
            }
          });
        }, { threshold: 0.5 });

        observer.observe(window.$disqus);
      },
      waitForPageReady: function () {
        if (document.readyState === "complete") {
          this.loadDisqus();
        } else {
          window.addEventListener("load", () => this.loadDisqus());
        }
      },
      loadDisqus: function () {
        if (!window.$disqus) return;

        if (window.DISQUS) {
          window.DISQUS.reset({ reload: true });
          return;
        }

        // 异步加载 Disqus 脚本
        (function () {
          const d = document,
            s = d.createElement("script");
          s.src = "https://invmy.disqus.com/embed.js";
          s.setAttribute("data-timestamp", String(+new Date()));
          s.async = true;
          (d.head || d.body).appendChild(s);
        })();
      },
    };

    window.DisqusWidget.init();
  }
</script>

<noscript>
  Please enable JavaScript to view the <a
    href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a
  >
</noscript>
